---
- name: Deploy Next.js app to EC2 (local)
  hosts: localhost
  connection: local
  gather_facts: yes
  become: yes
  vars:
    app_dir: /home/ec2-user/app
    app_owner: ec2-user
    app_group: ec2-user
    app_repo: https://github.com/mrdaiking/test_ansible.git
    app_branch: main
    app_subdir: my-nextjs-app
  tasks:
    - name: Ensure prerequisites are installed (git, curl, ca-certificates)
      ansible.builtin.package:
        name:
          - git
          - curl
          - ca-certificates
        state: present

    - name: Ensure application directory exists
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_owner }}"
        group: "{{ app_group }}"
        mode: "0755"

    - name: Checkout application repository
      ansible.builtin.git:
        repo: "{{ app_repo }}"
        dest: "{{ app_dir }}"
        version: "{{ app_branch }}"
        force: yes
        update: yes
      become_user: "{{ app_owner }}"

    - name: Install Node.js 18.x via NodeSource on RPM-based systems
      when: ansible_facts.packages is not defined and (ansible_facts.os_family | lower) in ["redhat", "amazon"]
      ansible.builtin.shell: |
        set -e
        curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
        sudo yum install -y nodejs
      args:
        executable: /bin/bash

    - name: Install Node.js 18.x via NodeSource on Debian/Ubuntu
      when: (ansible_facts.os_family | lower) in ["debian"]
      ansible.builtin.shell: |
        set -e
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
      args:
        executable: /bin/bash

    - name: Ensure pm2 is installed globally
      ansible.builtin.shell: |
        set -e
        sudo npm install -g pm2
      args:
        executable: /bin/bash

    - name: Install dependencies (npm ci if lockfile exists)
      become_user: "{{ app_owner }}"
      ansible.builtin.shell: |
        set -e
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
      args:
        chdir: "{{ app_dir }}/{{ app_subdir }}"
        executable: /bin/bash

    - name: Build Next.js app
      become_user: "{{ app_owner }}"
      ansible.builtin.shell: |
        set -e
        npm run build
      args:
        chdir: "{{ app_dir }}/{{ app_subdir }}"
        executable: /bin/bash

    - name: Start or restart app with PM2
      become_user: "{{ app_owner }}"
      ansible.builtin.shell: |
        set -e
        pm2 start npm --name "nextjs-app" -- run start || pm2 restart nextjs-app
        pm2 save
      args:
        chdir: "{{ app_dir }}/{{ app_subdir }}"
        executable: /bin/bash
